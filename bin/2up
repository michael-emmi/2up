#!/usr/bin/env bash

margin=20
paper=letter

function gsbbox {
  local file=$1
  gs -sDEVICE=bbox -dNOPAUSE -dBATCH $file 2>&1 | grep "%%BoundingBox" | cut -d' ' -f 2-5
}

function filter {
  local file=$1
  local selection=$2
  local outfile=${file/.pdf/.$selection.pdf}
  pdfjam -o $outfile $file $selection > /dev/null 2>&1
  echo $outfile
}

function crop {
  local file=$1
  local bbox=$2
  local outfile=${1/.pdf/.cropped.pdf}

  if [[ -z $bbox ]]
  then
    pdfcrop $file --margins $margin $outfile > /dev/null
  else
    pdfcrop $file --margins $margin --bbox "$bbox" $outfile > /dev/null
  fi
  echo $outfile
}

function join {
  local files=$@
  local outfile=${1/.pdf/.joined.pdf}
  pdfjoin -o $outfile $files --rotateoversize false --paper $paper > /dev/null 2>&1
  echo $outfile
}

function nup {
  local file=$1
  local outfile=${file/.pdf/.nup.pdf}
  pdfnup -o $outfile $file --paper $paper > /dev/null 2>&1
  echo $outfile
}

function split {
  local file=$1
  local selections=${@:2}
  local outfiles=""

  for selection in $selections
  do
    outfiles+=" $(filter $file $selection)"
  done
  echo $outfiles
}

function bbox {
  local file=$1
  local selection=$2
  gsbbox $(filter $file $selection)
}

function simple_compose {
  local file=$1
  nup $(crop $file)
}

function complex_compose {
  local file=$1
  local selections=$2
  local outliers=$3
  local keypage=$4
  local box=$(bbox $in $keypage)
  local splits=$(split $file $selections)
  local cropped=""
  local idx=1

  for selection in $selections
  do
    case $outliers in
    *"$selection"*)
      cropped+=" $(crop $(echo $splits | cut -f $idx  -d ' ') "$box")"
      ;;
    *)
      cropped+=" $(crop $(echo $splits | cut  -f $idx -d ' '))"
      ;;
    esac
    ((idx = idx + 1))
  done
  nup $(join $cropped)
}

function compose {
  local file=$1

  # TODO compute selections, outliers, key pages automatically
  # complex_compose $(basename $file) "1-1 2-" "1-1" "2"

  simple_compose $file
}

function main {
  local in=$1
  local file=$(basename $in)
  local dir=$(mktemp -d)

  trap "rm -rf $dir" EXIT
  cp $in $dir
  pushd $dir > /dev/null
  local composed=$(compose $file)
  popd > /dev/null
  cp $dir/$composed ${file/.pdf/.2up.pdf}
}

set -e
main $@
